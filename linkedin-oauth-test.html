<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn OAuth Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; background: #0077b5; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #005885; }
        .log { background: #f5f5f5; padding: 15px; margin: 10px 0; border-left: 4px solid #0077b5; }
        .error { border-left-color: #e74c3c; }
        .success { border-left-color: #27ae60; }
    </style>
</head>
<body>
    <h1>LinkedIn OAuth Configuration Test</h1>
    
    <h2>Configuration Details</h2>
    <div class="log">
        <strong>Client ID:</strong> 78094ft3hvizqs<br>
        <strong>Production Redirect URI:</strong> https://sameaisalesassistant.netlify.app/.netlify/functions/linkedin-callback<br>
        <strong>Local Redirect URI:</strong> http://localhost:5173/.netlify/functions/linkedin-callback<br>
        <strong>Required Scopes:</strong> openid, profile, email
    </div>

    <h2>Tests</h2>
    
    <button onclick="testNetlifyFunction()">1. Test Netlify Function</button>
    <div id="netlifyTest" class="log" style="display: none;"></div>
    
    <button onclick="testOAuthLocal()">2. Test OAuth (Local Dev)</button>
    <div id="localTest" class="log" style="display: none;"></div>
    
    <button onclick="testOAuthProduction()">3. Test OAuth (Production)</button>
    <div id="prodTest" class="log" style="display: none;"></div>

    <h2>LinkedIn Developer Portal Configuration</h2>
    <div class="log">
        <p><strong>Required Setup:</strong></p>
        <ol>
            <li>Go to <a href="https://www.linkedin.com/developers/apps" target="_blank">LinkedIn Developer Portal</a></li>
            <li>Find app with Client ID: <code>78094ft3hvizqs</code></li>
            <li>In <strong>Auth</strong> tab, ensure these redirect URIs are added:</li>
            <ul>
                <li><code>https://sameaisalesassistant.netlify.app/.netlify/functions/linkedin-callback</code></li>
                <li><code>http://localhost:5173/.netlify/functions/linkedin-callback</code> (for development)</li>
            </ul>
            <li>Verify these scopes are enabled: <code>openid</code>, <code>profile</code>, <code>email</code></li>
            <li>Ensure app status is <strong>Live</strong> (not Draft)</li>
        </ol>
    </div>

    <h2>Instructions</h2>
    <div class="log">
        <p><strong>Step 1:</strong> Click "Test Netlify Function" - should show "Function is working!"</p>
        <p><strong>Step 2:</strong> Click "Test OAuth (Local Dev)" if running locally</p>
        <p><strong>Step 3:</strong> Click "Test OAuth (Production)" to test live</p>
        <p><strong>Expected:</strong> OAuth popup should open LinkedIn login page, not close immediately</p>
    </div>

    <script>
        async function testNetlifyFunction() {
            const testDiv = document.getElementById('netlifyTest');
            testDiv.style.display = 'block';
            testDiv.className = 'log';
            testDiv.innerHTML = 'Testing Netlify function...';
            
            try {
                const response = await fetch('https://sameaisalesassistant.netlify.app/.netlify/functions/linkedin-callback?test=1');
                const data = await response.json();
                
                if (data.message === 'Function is working!') {
                    testDiv.className = 'log success';
                    testDiv.innerHTML = '‚úÖ Success: ' + data.message;
                } else {
                    testDiv.className = 'log error';
                    testDiv.innerHTML = '‚ùå Unexpected response: ' + JSON.stringify(data);
                }
            } catch (error) {
                testDiv.className = 'log error';
                testDiv.innerHTML = '‚ùå Error: ' + error.message;
            }
        }

        function testOAuthLocal() {
            testOAuth('http://localhost:5173/.netlify/functions/linkedin-callback', 'localTest');
        }

        function testOAuthProduction() {
            testOAuth('https://sameaisalesassistant.netlify.app/.netlify/functions/linkedin-callback', 'prodTest');
        }

        function testOAuth(redirectUri, testDivId) {
            const testDiv = document.getElementById(testDivId);
            testDiv.style.display = 'block';
            testDiv.className = 'log';
            testDiv.innerHTML = 'Opening OAuth popup...';
            
            const state = 'test_' + Date.now();
            const authUrl = 'https://www.linkedin.com/oauth/v2/authorization?' + 
                'response_type=code' +
                '&client_id=78094ft3hvizqs' +
                '&redirect_uri=' + encodeURIComponent(redirectUri) +
                '&state=' + state +
                '&scope=openid+profile+email';
            
            console.log('OAuth URL:', authUrl);
            
            const popup = window.open(authUrl, 'linkedin_oauth', 'width=600,height=700,scrollbars=yes');
            
            if (!popup) {
                testDiv.className = 'log error';
                testDiv.innerHTML = '‚ùå Popup blocked! Please allow popups for this site.';
                return;
            }
            
            let checkCount = 0;
            const checkInterval = setInterval(() => {
                checkCount++;
                try {
                    if (popup.closed) {
                        clearInterval(checkInterval);
                        if (checkCount < 5) {
                            testDiv.className = 'log error';
                            testDiv.innerHTML = '‚ùå Popup closed immediately. This usually indicates:<br>' +
                                '‚Ä¢ LinkedIn Developer Portal redirect URI mismatch<br>' +
                                '‚Ä¢ LinkedIn app not in Live status<br>' +
                                '‚Ä¢ Client ID not found<br><br>' +
                                'Check LinkedIn Developer Portal configuration above.';
                        } else {
                            testDiv.className = 'log';
                            testDiv.innerHTML = 'üîÑ OAuth flow completed (popup closed after ' + checkCount + ' seconds).<br>' +
                                'Check browser console for any errors or success messages.';
                        }
                    } else if (checkCount === 1) {
                        testDiv.className = 'log success';
                        testDiv.innerHTML = '‚úÖ OAuth popup opened successfully! Complete the LinkedIn authorization.';
                    }
                } catch (e) {
                    // Cross-origin access error means popup is still open and navigating
                    if (checkCount === 1) {
                        testDiv.className = 'log success';
                        testDiv.innerHTML = '‚úÖ OAuth popup opened successfully! Complete the LinkedIn authorization.';
                    }
                }
                
                // Stop checking after 60 seconds
                if (checkCount > 60) {
                    clearInterval(checkInterval);
                    testDiv.className = 'log';
                    testDiv.innerHTML = '‚è∞ Test timeout. If you completed authorization, check the main app for results.';
                }
            }, 1000);
        }
    </script>
</body>
</html>